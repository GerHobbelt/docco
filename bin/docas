#!/usr/bin/env bash

# ## Introduction
#
# **Docas** is a shell script used by **[Docas.io]** to generate (and
# synchronize) documentation for GitHub repositories. Docas relies on:
#
# 1. **[Git]**, of course!
# 2. **[Docco]**, (tweaked slightly), a quick-and-dirty, hundred-line-long,
# literate-programming-style documentation generator by [Jeremy Ashkenas].
# 3. **[Linguist HTTP]**, a HTTP wrapper for [Linguist].
#
# To use docas as a stand-alone program on your development machine, invoke
# docas from your local git repository.
#
#       $ pwd
#       /path/to/your/repo
#        docas
#
#   [Git]:             http://git-scm.com
#   [Docas.io]:        http://docas.io
#   [Docco]:           http://jashkenas.github.com/docco
#   [Jeremy Ashkenas]: http://jashkenas.github.com
#   [Linguist]:        http://github.com/github/linguist
#   [Linguist HTTP]:   http://github.com/baoshan/linguist_http
#

# ## Scripting Procedure

# ### Step 0: Preparations

# Stop execution on error.

set -e

# Ensure correct invocation pattern.
#
#   * When no argument is given, working directory is used to extract user and
#   repo name which are used to fetch (or clone) from GitHub. Local files are
#   not used to guarantee consistency.

if [ $# -eq 0 ]; then

  if [ "$(git rev-parse --is-inside-work-tree 2> /dev/null)" == "true" ]; then
 
    addr="$(git remote -v | egrep -m 1 "origin")"
    repo="$(echo $addr  | grep -P "(?<=\:).*(?= )" -o)"

  else

    echo -e "
    Docas documents git repository and publish as GitHub pages.

    Usage:\033[36m docas \033[0m              (document current directory) *
    or:   \033[36m docas <user>/<repo>\033[0m (document repository by user and repository name)
    
    * Sources on GitHub will be used instead of local files to guarantee consistency.
    "
    exit

  fi

#   * Else, provided argument should be of `user/repo` pattern, which will be
#   used to fetch (or clone) from GitHub.

else

  repo=$1

fi

# Prepare required directories. Total 4 folders are used to accomplish the
# whole task:
#
#   * `storage` directory, which should be a local non-volatile folder. All
#   fetched (or cloned) repositories are persisted on this location to
#   accelerate following fetches from GitHub. `storage` directory locates at
#   `(home directory)/docas-repos/`.
#   * `sources` directory, holding files of the master branch. `source`
#   directory locates at `user/repo` inside `storage` directory.
#   * `working` directory, holding docas required language statistics, list of
#   (all and touched) sources, and also below `ghpages` directory. Which is a 
#   volatile (temporary) folder and should be removed on exit.
#   * `ghpages` directory, holding generated documentation. `ghpages` directory
#   locates at `ghpages` inside `working` directory.

storage_dir="$(echo $HOME)/docas-repos" && mkdir -p "$storage_dir" # && cd "$storage_dir" && storage_dir=$(pwd -P)
sources_dir="$storage_dir/$repo"
working_dir="$(mktemp -d /tmp/repo.$$.XXXXXXXXXX)" && trap "rm -rf "$working_dir"; exit;" 0 SIGINT SIGTERM
ghpages_dir="$working_dir/ghpages"

# ### Step 1: Fetch (or Clone) from GitHub

# If `sources_dir` is a git repository already, then fetch from upstream. The
# `--hard` option is feeded into `git reset` to handle repository (or user)
# rename scenarios.

sources_git="$sources_dir/.git"
if [ -d "$sources_git" ] && [ "$(git --git-dir $sources_git rev-parse --is-inside-work-tree)" == "true" ]; then

  echo -n "Fetching from GitHub..."
  cd "$sources_dir"
  git fetch --quiet --force
  git reset --quiet --hard  origin/master
  git remote prune origin
  echo "Done"

# Else, before clone the repository, clear the content of `storage_dir`. Shallow
# clone is used to save bandwidth and improve speed.

else

  rm -rf "$storage_dir"
  git clone --depth 1 --quiet "git@github.com:$repo.git" "$sources_dir"

fi

# ### Step 2: Checkout (or Generate) gh-pages Branch, List Touched Files

# Docas will only re-render documents for touched sources, in some scenarios,
# docas treats all files as touched:
#
#   1. `gh-pages` branch does not exist, which could be mis-judged when invoking
#   from a development environment (remote `gh-pages` branch is untracked). Not
#   a problem on docas.io environment.
#   2. No docas commit found from the `gh-pages` branch, which could be caused
#   by first synchronization, or shallow clone.
#   3. `gh-pages` sync found, but could not target according `master` commit,
#   caused by shallow clone.

all_files_are_touched () {

  cp "$working_dir/.all" "$working_dir/.touched"
  echo > "$working_dir/.deleted"
  return

}

# Get `HEAD` commit hash, and list all git versioned files.

cd "$sources_dir"
head_hash="$(git rev-parse HEAD | head -c 7)"
git ls-tree -r --name-only HEAD > "$working_dir/.all"

# Create `gh-pages` branch if not exist, see: [GitHub instruction]:
#
#   1. Copy sources to `gh-pages` directory.
#   2. Change to `gh-pages` directory.
#   3. Create `gh-pages` branch. 
#   4. Clear git index.
#   5. Remove all files.
#
# In this situation, docas considers all directories are dirty.
# [GitHub instruction]: http://help.github.com/pages/#project_pages_manually 

if [ "$(git branch -a | grep origin\/gh-pages | wc -l)" -eq 0 ]; then

  echo "Creating gh-pages branch..."
  cp -R "$sources_dir" "$ghpages_dir" && cd "$ghpages_dir"
  git symbolic-ref HEAD refs/heads/gh-pages
  rm -f .git/index
  git clean --quiet -fdx

  all_files_are_touched

# If there exists a `gh-pages` branch, which means the branch *may* contain docas
# synchronized content. So, docas will:
#
#   1. Copy sources to `ghpages` directory.
#   2. Empty `ghpages` directory, incase of submodules were touched on dev
#   machine, which will cause `unable to rmdir *name of submodule*: Directory
#   not empty` warning and unwanted files being left.
#   3. Switch to branch `gh-pages`.
#   4. Analyze touched files. Touched files are:
#
#     a. When docas can securely locate the synchronized sources commit, then
#     the `diff` between that commit and `HEAD` are touched.
#     b. Otherwise, docas treats all git versioned files are touched.

else

  cp -R "$sources_dir" "$ghpages_dir" && cd "$ghpages_dir"
  rm -rf *
  echo "checkouting"
  pwd
  git checkout --force --quiet -b gh-pages origin/gh-pages > /dev/null
  echo "reseting"
  git reset --quiet --hard origin/gh-pages

  synced_docas_commit=$(git log --pretty=oneline | egrep -m 1 -i "^[0-9a-f]+.* docas.*synced.*[0-9a-f]+$")
  synced_ghpages_hash=$(echo "$synced_docas_commit" | head -c 7)
  synced_sources_hash=$(echo "$synced_docas_commit" | tail -c 8 | head -c 7)

  cd $sources_dir
  synced_sources_hash=$(git log --pretty=oneline | egrep -m 1 "^$synced_sources_hash" | head -c 7 | xargs echo)

  echo "$synced_sources_hash | $synced_ghpages_hash"

  if [ "$synced_sources_hash" == "$head_hash" ]; then

    echo "Already synchronized with latest commit."
    exit 0

  fi

  # If we can not securely list all touched files, docas will treat all files as
  # touched.
  if [ -z "$synced_ghpages_hash" ] || [ -z "$synced_sources_hash" ]; then

    echo "gh-pages branch out-of-sync for a long time, rebuilding..."
    all_files_are_touched
    
  # If we can securely list all touched files in the `master` and `gh-pages`
  # branch since last sync, output unique directories into dirty_directories file.
  else

    echo "Docas previously comitted gh-pages found, synced with $synced_sources_hash"
    cd "$sources_dir"
    git diff --name-status $synced_sources_hash..HEAD > "$working_dir/.git-diff"
    egrep "^(A|M)" "$working_dir/.git-diff" | cut -c 3- > "$working_dir/.touched"
    egrep "^D"     "$working_dir/.git-diff" | cut -c 3- > "$working_dir/.deleted"

  fi

fi

# ### Step 3: Language Analysis, List Touched Sources

# Get language statistics, all and touched sources from `Linguist HTTP` server
# listening local port 4567.

echo > "$working_dir/.all_sources"
echo > "$working_dir/.touched_sources"
curl --silent --output "$working_dir/.statist"         "http://127.0.0.1:4567/statist?path=$sources_dir"
curl --silent --output "$working_dir/.all_sources"     "http://127.0.0.1:4567/sources?path=$sources_dir&list=$working_dir/.all"
curl --silent --output "$working_dir/.touched_sources" "http://127.0.0.1:4567/sources?path=$sources_dir&list=$working_dir/.touched"

# ### Step 4: Synchronize Documents (using Docco)

echo "Generating documents..."

# 1. Synchronize deleted sources

cd "$ghpages_dir"
cat "$working_dir/.deleted" | while read file; do
  # TODO: Hidden file without extension.
  rm -f "${file%.*}.html"
done

# 2. Make sure a stylesheet for documents exists.
# Make sure a stylesheet for documents exists. User modification will be
# honored. In case of the stylesheet doesn't exists, copy the default stylesheet
# to the `stylesheets` folder.

cd "$ghpages_dir"
if ! [ -f "stylesheets/docco.css" ]; then
  mkdir -p "stylesheets"
  cp "/usr/local/lib/docas/resources/docco.css" "stylesheets/docco.css"
fi

mkdir -p javascript
cp "/usr/local/lib/docas/vendor/jquery.min.js" "javascript/jquery.min.js"
cp "/usr/local/lib/docas/vendor/filesize.js" "javascript/filesize.js"
cp "/usr/local/lib/docas/vendor/moment.min.js" "javascript/moment.min.js"
cp "/usr/local/lib/docas/vendor/underscore-min.js" "javascript/underscore-min.js"
cp "/usr/local/lib/docas/lib/file_browser.js" "javascript/file_browser.js"
 
# 3. Generate documents using docco.
cd "$sources_dir"
cat "$working_dir/.touched_sources" | tr '\n' '\0' | xargs -0 docco -o "$ghpages_dir"

# ### Step 5: Generate Cover Page (using Docci)

echo -n "Generating Indexes..."

doccx -s $sources_dir -w $working_dir

echo "Done" && echo -n "Generating cover page..."

# Upon this phase, following materials were all ready:
#
#   1. a language statistics named `.statist`, and,
#   2. a list of all recognized sources named `.all_sources`.
#
# Make sure a stylesheet for `index.html` exists. (User modification will be
# honored.)
# 
# Invoke the **docci** command-line program to generate `index.html`.

cd $ghpages_dir
if ! [ -f "stylesheets/index.css" ]; then
 
  mkdir -p "stylesheets"
  cp "/usr/local/lib/docas/resources/index.css" "stylesheets/index.css"

fi

docci -o "$ghpages_dir" "$sources_dir"

echo "Done"

# ### Step 6: Push to Upstream

# Upon this phase, updated cover page (always) and documentations (probably) are
# all ready. It's time to push back to `gh-pages` branch on GitHub.
#
# The [porcelain layer] of git-status is used to count files been created,
# modified, or deleted. Output these numbers to the terminal.
#
# [Porcelain Layer]:
# http://schacon.github.com/git/git.html#_high_level_commands_porcelain

cd "$ghpages_dir"
status="$(git status --porcelain)"
echo "Created:$(echo "$status" | egrep "^(\?\?)" | wc -l)"
echo "Altered:$(echo "$status" | egrep "^(M| M)" | wc -l)"
echo "Deleted:$(echo "$status" | egrep "^(D| D)" | wc -l)"

# Following below steps to update gh-pages:
# 
#   1. Synchronize git index with local files,
#   2. Commit the `gh-pages` branch, and,
#   3. Synchronize the `gh-pages` branch with GitHub remotely.

echo "$status"
echo "Pushing to gh-pages branch on GitHub..."
git add    .
git commit --all --quiet --message "Docas.io synced with $head_hash"
git push         --quiet           origin gh-pages
echo "Branch gh-pages synced with master. Crowd applauds."

# ### Step 7: Coda

# Update `sources` directory again to make following synchronizations quicker
# for no need to fetch (just pushed) documentations again.

cd "$sources_dir"
git pull

# git fetch --quiet --force
# git checkout gh-pages
# git reset --quiet --hard  origin/gh-pages
# git checkout master
